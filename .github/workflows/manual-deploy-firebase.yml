name: Manual Deploy to Firebase Hosting

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        type: string

env:
  GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
  CHAT_API_ENDPOINT: ${{ vars.CHAT_API_ENDPOINT }}
  DEFAULT_CHAT_LOCATION: ${{ vars.DEFAULT_CHAT_LOCATION }}

jobs:
  call_reusable_build:
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      node-version: '20'
      expo-working-directory: 'ExpoGallery'
      output-path: 'dist'

  build_and_deploy_firebase:
    needs: call_reusable_build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.call_reusable_build.outputs.build_artifact_name }}
          path: downloaded-artifact

      - name: Prepare Firebase deployment directory
        run: |
          mkdir -p site/public
          echo "Copying from ./downloaded-artifact/${{ needs.call_reusable_build.outputs.build_output_dir_name }} to ./site/public/"
          cp -r ./downloaded-artifact/${{ needs.call_reusable_build.outputs.build_output_dir_name }}/* ./site/public/
          echo "Expected version.json at: ./site/public/${{ needs.call_reusable_build.outputs.version_json_relative_path }}"
          ls -l ./site/public/${{ needs.call_reusable_build.outputs.version_json_relative_path }}

      - name: Determine Firebase Channel ID
        id: channel_id
        run: |
          CHANNEL_ID=""
          BRANCH_NAME=$(echo "${{ github.event.inputs.branch }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | cut -c1-36 | sed 's/^-*\(.*[^-]\)-*$//')
          NORMALIZED_BRANCH_INPUT=$(echo "${{ github.event.inputs.branch }}" | tr '[:upper:]' '[:lower:]')
          if [ "$NORMALIZED_BRANCH_INPUT" == "main" ]; then
            CHANNEL_ID="live"
          elif [ -z "$BRANCH_NAME" ]; then
            CHANNEL_ID="preview-manual"
          else
            CHANNEL_ID="preview-$BRANCH_NAME"
          fi
          echo "Firebase Channel ID: $CHANNEL_ID"
          echo "channel_id=$CHANNEL_ID" >> $GITHUB_OUTPUT

      - name: Replace GITHUB_SHA in about.html
        working-directory: ./site/public
        run: |
          if [ -f "about.html" ]; then
            echo "Replacing GITHUB_SHA in about.html with ${{ github.sha }}"
            sed -i.bak 's/GITHUB_SHA/'${GITHUB_SHA}'/g' about.html
          else
            echo "about.html not found in current directory (expected ./site/public/about.html)"
          fi

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        id: firebase_deploy
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPCHATAI }}
          entryPoint: ./site
          projectId: mapchatai
          channelId: ${{ steps.channel_id.outputs.channel_id }}

      - name: Verify deployed SHA
        env:
          CHANNEL_ID_OUTPUT: ${{ steps.channel_id.outputs.channel_id }}
          FIREBASE_PROJECT_ID: mapchatai
          FIREBASE_DEPLOY_DETAILS: ${{ steps.firebase_deploy.outputs.details }}
        run: |
          EXPECTED_SHA="${{ github.sha }}"
          sudo apt-get update && sudo apt-get install -y jq
          echo "Firebase Deploy Details: $FIREBASE_DEPLOY_DETAILS"
          ACTUAL_SITE_URL=""
          if [ "$CHANNEL_ID_OUTPUT" == "live" ]; then
            ACTUAL_SITE_URL=$(echo "$FIREBASE_DEPLOY_DETAILS" | jq -r --arg project_id "$FIREBASE_PROJECT_ID" '.[$project_id].live.url')
          else
            ACTUAL_SITE_URL=$(echo "$FIREBASE_DEPLOY_DETAILS" | jq -r --arg project_id "$FIREBASE_PROJECT_ID" --arg channel_prefix "$CHANNEL_ID_OUTPUT" '.[$project_id] | to_entries[] | select(.key | startswith($channel_prefix)) | .value.url')
          fi
          if [ -z "$ACTUAL_SITE_URL" ] || [ "$ACTUAL_SITE_URL" == "null" ]; then
            echo "::error::Could not extract site URL from Firebase deployment details."
            exit 1
          fi
          DEPLOYED_VERSION_URL="$ACTUAL_SITE_URL/${{ needs.call_reusable_build.outputs.version_json_relative_path }}"
          echo "Fetching deployed version from: $DEPLOYED_VERSION_URL"
          DEPLOYED_SHA=""
          for i in 1 2 3 4 5; do
            HTTP_CODE=$(curl -s -w "%{http_code}" -o response.json "$DEPLOYED_VERSION_URL")
            if [ "$HTTP_CODE" -eq 200 ]; then
              DEPLOYED_SHA=$(jq -r '.build' response.json)
              if [ -n "$DEPLOYED_SHA" ] && [ "$DEPLOYED_SHA" != "null" ]; then
                echo "Successfully fetched deployed SHA: $DEPLOYED_SHA"
                break
              fi
            fi
            echo "Attempt $i: Failed to fetch or parse version.json (HTTP: $HTTP_CODE) from $DEPLOYED_VERSION_URL. Retrying in 10 seconds..."
            sleep 10
          done
          if [ -z "$DEPLOYED_SHA" ] || [ "$DEPLOYED_SHA" == "null" ]; then
            echo "::error::Could not fetch deployed SHA from $DEPLOYED_VERSION_URL after multiple retries."
            cat response.json
            exit 1
          fi
          echo "Deployed SHA: $DEPLOYED_SHA"
          echo "Expected SHA: $EXPECTED_SHA"
          if [ "$DEPLOYED_SHA" != "$EXPECTED_SHA" ]; then
            echo "::error::Deployed SHA ($DEPLOYED_SHA) does not match expected SHA ($EXPECTED_SHA)."
            exit 1
          fi
          echo "Successfully verified deployed SHA on $DEPLOYED_VERSION_URL"
        shell: bash
